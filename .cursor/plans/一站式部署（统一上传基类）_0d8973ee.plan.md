---
name: ä¸€ç«™å¼éƒ¨ç½²ï¼ˆç»Ÿä¸€ä¸Šä¼ åŸºç±»ï¼‰
overview: åˆ›å»ºç»Ÿä¸€çš„ ProjectUploader åŸºç±»ï¼Œæ¯ä¸ªé¡¹ç›®çš„ upload_models.py åªéœ€æç®€è°ƒç”¨ï¼Œæ•´åˆæ¨¡å‹ä¸Šä¼ å’Œä¾èµ–å®‰è£…æµç¨‹ã€‚
todos:
  - id: create-uploader
    content: åˆ›å»º src/project_uploader.py ç»Ÿä¸€ä¸Šä¼ åŸºç±»
    status: completed
  - id: extend-base
    content: æ‰©å±• src/projects/base.py æ·»åŠ  models_remote_prefix å’Œ local_models_dir
    status: completed
  - id: update-config
    content: æ›´æ–° src/projects/speaker_diarization/config.py æ·»åŠ æ¨¡å‹è·¯å¾„é…ç½®
    status: completed
  - id: create-upload-script
    content: åˆ›å»º src/projects/speaker_diarization/upload_models.py æç®€ä¸Šä¼ è„šæœ¬
    status: completed
  - id: create-deploy-cmd
    content: åˆ›å»º src/commands/deploy.py å®ç° deploy å‘½ä»¤
    status: completed
  - id: update-cli
    content: ä¿®æ”¹ volume_cli.py æ·»åŠ  deploy å­å‘½ä»¤
    status: completed
  - id: create-doc
    content: åˆ›å»º DEPLOYMENT_GUIDE.md éƒ¨ç½²æ–‡æ¡£
    status: completed
  - id: update-model-doc
    content: æ›´æ–° MODEL_DEPLOYMENT_GUIDE.md æ·»åŠ æ–°æ–‡æ¡£é“¾æ¥
    status: completed
---

# ä¸€ç«™å¼éƒ¨ç½²æ–¹æ¡ˆï¼ˆç»Ÿä¸€ä¸Šä¼ åŸºç±»ï¼‰

## èƒŒæ™¯

æ¯ä¸ªé¡¹ç›®åº”è¯¥æ˜¯**è‡ªåŒ…å«**çš„ï¼Œä½†ä¸Šä¼ é€»è¾‘åº”è¯¥**ç»Ÿä¸€å¤ç”¨**ï¼š

- é…ç½®ï¼š`config.py`ï¼ˆå®šä¹‰æ¨¡å‹è·¯å¾„ï¼‰
- ä¾èµ–ï¼š`dependencies.yaml`
- ä¸Šä¼ è„šæœ¬ï¼š`upload_models.py`ï¼ˆæç®€è°ƒç”¨ç»Ÿä¸€åŸºç±»ï¼‰
- ä¸Šä¼ åŸºç±»ï¼š`src/project_uploader.py`ï¼ˆç»Ÿä¸€é€»è¾‘ï¼‰

## æ¶æ„è®¾è®¡

```javascript
src/
â”œâ”€â”€ project_uploader.py          # ç»Ÿä¸€ä¸Šä¼ åŸºç±»ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ s3_uploader.py               # åº•å±‚ S3 å·¥å…·ï¼ˆå·²æœ‰ï¼‰
â”œâ”€â”€ projects/
â”‚   â”œâ”€â”€ base.py                  # é¡¹ç›®åŸºç±»ï¼ˆæ‰©å±•ï¼‰
â”‚   â””â”€â”€ speaker_diarization/
â”‚       â”œâ”€â”€ config.py            # é¡¹ç›®é…ç½®ï¼ˆæ‰©å±•ï¼‰
â”‚       â”œâ”€â”€ dependencies.yaml    # ä¾èµ–é…ç½®ï¼ˆå·²æœ‰ï¼‰
â”‚       â””â”€â”€ upload_models.py     # ä¸Šä¼ è„šæœ¬ï¼ˆæ–°å¢ï¼Œæç®€ï¼‰
â””â”€â”€ commands/
    â””â”€â”€ deploy.py                # deploy å‘½ä»¤ï¼ˆæ–°å¢ï¼‰
```



## å®æ–½æ­¥éª¤

### 1. æ‰©å±• BaseProject æ”¯æŒæ¨¡å‹è·¯å¾„é…ç½®

**æ–‡ä»¶**: [`src/projects/base.py`](src/projects/base.py:10-72)**æ–°å¢å±æ€§**:

```python
@property
def models_remote_prefix(self) -> str:
    """
    æ¨¡å‹åœ¨ Volume ä¸­çš„å­ç›®å½•åï¼ˆé¡¹ç›®éš”ç¦»ï¼‰
    é»˜è®¤ä½¿ç”¨é¡¹ç›®åï¼Œå­ç±»å¯è¦†ç›–
    
    ç¤ºä¾‹: 'speaker-reg' 
    ç»“æœ: /runpod-volume/models/speaker-reg/
    """
    return self.name

@property
def local_models_dir(self) -> Optional[str]:
    """
    æœ¬åœ°æ¨¡å‹ç›®å½•ï¼ˆç”¨äº S3 ä¸Šä¼ ï¼‰
    è¿”å›æœ¬åœ°æ¨¡å‹æ–‡ä»¶çš„æ ¹ç›®å½•è·¯å¾„
    
    ç¤ºä¾‹: '/Users/xxx/Downloads/speaker-reg/models'
    ä¸Šä¼ å: /runpod-volume/models/speaker-reg/...
    
    è¿”å› None è¡¨ç¤ºéœ€è¦é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æŒ‡å®š
    """
    return None
```



### 2. æ›´æ–° speaker_diarization é¡¹ç›®é…ç½®

**æ–‡ä»¶**: [`src/projects/speaker_diarization/config.py`](src/projects/speaker_diarization/config.py:11-34)**æ·»åŠ é…ç½®**:

```python
@property
def models_remote_prefix(self):
    """æ¨¡å‹åœ¨ Volume ä¸­çš„å­ç›®å½•"""
    return 'speaker-reg'  # ä¿æŒä¸ç°æœ‰ä¸Šä¼ è„šæœ¬ä¸€è‡´

@property
def local_models_dir(self):
    """æœ¬åœ°æ¨¡å‹ç›®å½•ï¼ˆå¯é€‰ï¼‰"""
    # è¿”å› Noneï¼Œé€šè¿‡å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šï¼ˆæ¨èï¼‰
    return None
```



### 3. åˆ›å»ºç»Ÿä¸€çš„é¡¹ç›®ä¸Šä¼ å™¨åŸºç±»

**æ–‡ä»¶**: `src/project_uploader.py` (æ–°å»º)**åŠŸèƒ½**:

- ç»Ÿä¸€çš„ä¸Šä¼ é€»è¾‘
- è¯»å–é¡¹ç›®é…ç½®
- æ”¯æŒå‘½ä»¤è¡Œå‚æ•°
- å¤ç”¨ `s3_uploader.upload_directory`

**æ ¸å¿ƒä»£ç **:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""é¡¹ç›®æ¨¡å‹ä¸Šä¼ å™¨åŸºç±»"""
import sys
import argparse
from pathlib import Path
from typing import Optional
from src.s3_uploader import upload_directory
from src.projects.base import BaseProject


class ProjectUploader:
    """é¡¹ç›®æ¨¡å‹ä¸Šä¼ å™¨"""
    
    @staticmethod
    def upload(
        project: BaseProject,
        models_dir: Optional[str] = None,
        volume_path: str = '/workspace'
    ) -> int:
        """
        ä¸Šä¼ é¡¹ç›®æ¨¡å‹åˆ° S3
        
        Args:
            project: é¡¹ç›®é…ç½®å¯¹è±¡
            models_dir: æœ¬åœ°æ¨¡å‹ç›®å½•ï¼ˆå¯é€‰ï¼Œè¦†ç›–é¡¹ç›®é…ç½®ï¼‰
            volume_path: Volume æŒ‚è½½è·¯å¾„
        
        Returns:
            0: æˆåŠŸ, 1: å¤±è´¥
        """
        local_dir = models_dir or project.local_models_dir
        if not local_dir:
            print("âŒ é”™è¯¯: æœªæŒ‡å®šæœ¬åœ°æ¨¡å‹ç›®å½•")
            print("\nä½¿ç”¨æ–¹å¼:")
            print("  python3 <script> --models-dir /path/to/models")
            print("\næˆ–åœ¨ config.py ä¸­é…ç½® local_models_dir")
            return 1
        
        print(f"ğŸš€ ä¸Šä¼  {project.name} æ¨¡å‹åˆ° S3\n")
        print(f"æœ¬åœ°ç›®å½•: {local_dir}")
        print(f"è¿œç¨‹å‰ç¼€: {project.models_remote_prefix}")
        print(f"Volumeè·¯å¾„: {volume_path}/models/{project.models_remote_prefix}/\n")
        
        result = upload_directory(
            local_dir=local_dir,
            remote_prefix=project.models_remote_prefix,
            models_subdir=f'{volume_path}/models',
            include_parent_dir=False,
            verbose=True
        )
        
        print(f"\n{'='*60}")
        print(f"ğŸ“Š ä¸Šä¼ å®Œæˆ: {result['success']}/{result['total']}")
        print(f"{'='*60}")
        
        if result['failed'] > 0:
            print(f"âš ï¸  {result['failed']} ä¸ªæ–‡ä»¶ä¸Šä¼ å¤±è´¥")
            return 1
        else:
            print(f"âœ… æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼")
            return 0
    
    @staticmethod
    def main_cli(project: BaseProject):
        """CLI å…¥å£ï¼ˆä¾›é¡¹ç›®è„šæœ¬è°ƒç”¨ï¼‰"""
        parser = argparse.ArgumentParser(
            description=f'ä¸Šä¼  {project.name} æ¨¡å‹åˆ° S3'
        )
        parser.add_argument(
            '--models-dir',
            help='æœ¬åœ°æ¨¡å‹ç›®å½•ï¼ˆè¦†ç›–é…ç½®ï¼‰'
        )
        parser.add_argument(
            '--volume-path',
            default='/workspace',
            help='VolumeæŒ‚è½½è·¯å¾„ï¼ˆé»˜è®¤: /workspaceï¼‰'
        )
        args = parser.parse_args()
        
        return ProjectUploader.upload(
            project,
            args.models_dir,
            args.volume_path
        )
```



### 4. åˆ›å»ºé¡¹ç›®ä¸“å±ä¸Šä¼ è„šæœ¬ï¼ˆæç®€ï¼‰

**æ–‡ä»¶**: `src/projects/speaker_diarization/upload_models.py` (æ–°å»º)**æç®€ä»£ç **ï¼ˆä»… 8 è¡Œï¼‰:

```python
#!/usr/bin/env python3
"""ä¸Šä¼  speaker-diarization æ¨¡å‹åˆ° S3"""
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent.parent.parent))

from src.project_uploader import ProjectUploader
from src.projects.speaker_diarization.config import SpeakerDiarizationProject

if __name__ == '__main__':
    exit(ProjectUploader.main_cli(SpeakerDiarizationProject()))
```

**ä½¿ç”¨æ–¹å¼**:

```bash
python3 src/projects/speaker_diarization/upload_models.py \
  --models-dir /path/to/models
```



### 5. åˆ›å»º deploy å‘½ä»¤å®ç°

**æ–‡ä»¶**: `src/commands/deploy.py` (æ–°å»º)**åŠŸèƒ½**:

- è°ƒç”¨ `ProjectUploader.upload` ä¸Šä¼ æ¨¡å‹
- è¾“å‡ºä¸´æ—¶ Pod ä¾èµ–å®‰è£…å‘½ä»¤
- è¾“å‡ºéªŒè¯æ¸…å•å’Œä¸šåŠ¡å®¹å™¨é…ç½®

**æ ¸å¿ƒé€»è¾‘**:

```python
from src.projects.loader import get_project
from src.project_uploader import ProjectUploader

def handle_deploy(args):
    """å¤„ç† deploy å‘½ä»¤"""
    project = get_project(args.project)
    
    print("="*60)
    print(f"ğŸš€ ä¸€ç«™å¼éƒ¨ç½²: {project.name}")
    print("="*60)
    
    # 1. ä¸Šä¼ æ¨¡å‹
    if not args.skip_upload:
        print(f"\n[1/4] ğŸ“¤ ä¸Šä¼ æ¨¡å‹åˆ° S3")
        print("â”€"*60)
        result = ProjectUploader.upload(
            project,
            args.models_dir,
            args.volume_path
        )
        if result != 0:
            print("\nâš ï¸  æ¨¡å‹ä¸Šä¼ å¤±è´¥ï¼Œä½†ç»§ç»­è¾“å‡ºéƒ¨ç½²æŒ‡å—...")
    else:
        print(f"\n[1/4] â­ï¸  è·³è¿‡æ¨¡å‹ä¸Šä¼ ")
    
    # 2. è¾“å‡ºä¾èµ–å®‰è£…æŒ‡å—
    print(f"\n[2/4] ğŸ“‹ ä¸´æ—¶ Pod ä¾èµ–å®‰è£…å‘½ä»¤")
    print("â”€"*60)
    print("åœ¨ RunPod æ§åˆ¶å°åˆ›å»ºä¸´æ—¶ Podï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\n")
    print("  git clone https://github.com/xxx/runpod-model-manager.git")
    print("  cd runpod-model-manager")
    print("  pip install -r requirements.txt")
    print(f"  python3 volume_cli.py deps install --project {project.name}")
    
    # 3. è¾“å‡ºéªŒè¯æ¸…å•
    print(f"\n[3/4] âœ… éªŒè¯æ¸…å•")
    print("â”€"*60)
    print(f"â–¡ æ¨¡å‹: {args.volume_path}/models/{project.models_remote_prefix}/")
    print(f"â–¡ ä¾èµ–: {args.volume_path}/python-deps/py{project.python_version}/{project.name}/")
    print(f"\néªŒè¯å‘½ä»¤:")
    print(f"  python3 volume_cli.py status --project {project.name}")
    
    # 4. è¾“å‡ºä¸šåŠ¡å®¹å™¨é…ç½®
    print(f"\n[4/4] ğŸ³ ä¸šåŠ¡å®¹å™¨é…ç½®")
    print("â”€"*60)
    print("# handler.py")
    print("import sys")
    print(f"sys.path.insert(0, '{args.volume_path}/python-deps/py{project.python_version}/{project.name}')")
    print("\nimport os")
    print(f"os.environ['MODELSCOPE_CACHE'] = '{args.volume_path}/models'")
```



### 6. æ‰©å±• volume_cli.py æ·»åŠ  deploy å‘½ä»¤

**æ–‡ä»¶**: [`volume_cli.py`](volume_cli.py:195-220)**æ–°å¢å­å‘½ä»¤**:

```python
# ==================== deploy å‘½ä»¤ ====================
deploy_parser = subparsers.add_parser(
    'deploy',
    help='ä¸€ç«™å¼éƒ¨ç½²ï¼ˆä¸Šä¼ æ¨¡å‹+ç”Ÿæˆä¾èµ–å®‰è£…å‘½ä»¤ï¼‰'
)
deploy_parser.add_argument('--project', required=True, help='é¡¹ç›®åç§°')
deploy_parser.add_argument('--models-dir', help='æœ¬åœ°æ¨¡å‹ç›®å½•ï¼ˆå¯é€‰ï¼‰')
deploy_parser.add_argument('--volume-path', default='/runpod-volume', help='VolumeæŒ‚è½½è·¯å¾„')
deploy_parser.add_argument('--skip-upload', action='store_true', help='è·³è¿‡æ¨¡å‹ä¸Šä¼ ')
```

**åˆ†å‘é€»è¾‘**:

```python
elif args.command == 'deploy':
    from src.commands.deploy import handle_deploy
    handle_deploy(args)
```



### 7. åˆ›å»ºéƒ¨ç½²æ–‡æ¡£

**æ–‡ä»¶**: `DEPLOYMENT_GUIDE.md` (æ–°å»º)**å†…å®¹**:

- å‰ç½®æ¡ä»¶
- ä¸‰ç§éƒ¨ç½²æ–¹å¼å¯¹æ¯”
- å®Œæ•´éƒ¨ç½²æµç¨‹
- éªŒè¯æ–¹æ³•
- ä¸šåŠ¡å®¹å™¨é…ç½®ç¤ºä¾‹

### 8. æ›´æ–° MODEL_DEPLOYMENT_GUIDE.md

**æ–‡ä»¶**: [`MODEL_DEPLOYMENT_GUIDE.md`](MODEL_DEPLOYMENT_GUIDE.md:1-20)åœ¨å¼€å¤´æ·»åŠ æŒ‡å‘æ–°æ–‡æ¡£çš„é“¾æ¥ã€‚

## ä½¿ç”¨ç¤ºä¾‹

### æ–¹å¼1: ä½¿ç”¨é¡¹ç›®ä¸“å±è„šæœ¬

```bash
python3 src/projects/speaker_diarization/upload_models.py \
  --models-dir /path/to/models
```



### æ–¹å¼2: ä½¿ç”¨ deploy å‘½ä»¤ï¼ˆæ¨èï¼‰

```bash
python3 volume_cli.py deploy \
  --project speaker-diarization \
  --models-dir /path/to/models
```



### æ–¹å¼3: ä»…è¾“å‡ºéƒ¨ç½²æŒ‡å—

```bash
python3 volume_cli.py deploy \
  --project speaker-diarization \
  --skip-upload
```



## å…³é”®æ–‡ä»¶

| æ–‡ä»¶ | ä½œç”¨ | çŠ¶æ€ ||------|------|------|| `src/project_uploader.py` | ç»Ÿä¸€ä¸Šä¼ åŸºç±» | æ–°å»º || `src/projects/base.py` | æ–°å¢ models_remote_prefix å’Œ local_models_dir | ä¿®æ”¹ || `src/projects/speaker_diarization/config.py` | æ·»åŠ æ¨¡å‹è·¯å¾„é…ç½® | ä¿®æ”¹ || `src/projects/speaker_diarization/upload_models.py` | é¡¹ç›®ä¸“å±ä¸Šä¼ è„šæœ¬ï¼ˆæç®€ï¼‰ | æ–°å»º || `src/commands/deploy.py` | deploy å‘½ä»¤å®ç° | æ–°å»º || `volume_cli.py` | æ·»åŠ  deploy å­å‘½ä»¤ | ä¿®æ”¹ || `DEPLOYMENT_GUIDE.md` | ä¸€ç«™å¼éƒ¨ç½²æ–‡æ¡£ | æ–°å»º || `MODEL_DEPLOYMENT_GUIDE.md` | æ·»åŠ æ–°æ–‡æ¡£é“¾æ¥ | ä¿®æ”¹ |

## ä¼˜åŠ¿

1. **ç»Ÿä¸€åŸºç±»**: æ‰€æœ‰é¡¹ç›®å¤ç”¨ `ProjectUploader`ï¼Œé¿å…é‡å¤ä»£ç 
2. **æç®€è„šæœ¬**: æ¯ä¸ªé¡¹ç›®çš„ `upload_models.py` åªéœ€ 8 è¡Œä»£ç 